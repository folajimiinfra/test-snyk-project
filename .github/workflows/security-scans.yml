name: Security CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Test Job: Runs tests and enforces coverage threshold
  test:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run Tests with 80% Coverage Threshold
        run: |
          # Enforce 80% coverage on branches, functions, lines, and statements
          npx jest --coverage --coverageThreshold='{"global":{"branches":80,"functions":80,"lines":80,"statements":80}}'
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # 2. Snyk Scan Job: Runs only if tests pass
  snyk-scan:
    name: Snyk Security Analysis
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Install Snyk CLI
        run: npm install -g snyk
      - name: Run Snyk SCA Scan
        run: |
          echo "Running Snyk SCA..."
          snyk test --json --all-projects > snyk-sca.json || true
          echo "SCA Results:"
          jq '.vulnerabilities | length' snyk-sca.json || echo "0"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Run Snyk Code Scan
        run: |
          echo "Running Snyk Code..."
          snyk code test --json > snyk-code.json || true
          echo "Code Results:"
          jq '.results | length' snyk-code.json || echo "0"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Merge Snyk Results
        run: |
          # Combine SCA and Code results into one JSON
          # We use -s to read both files into an array, then add them together
          jq -s '.[0] * .[1]' snyk-sca.json snyk-code.json > snyk-results.json || cp snyk-sca.json snyk-results.json
          echo "Combined Snyk Findings:"
          jq '.vulnerabilities | length' snyk-results.json || echo "No SCA"
          jq '.results | length' snyk-results.json || echo "No Code"
      - name: Upload Snyk Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-results
          path: snyk-results.json

  # 3. SonarQube Scan Job: Runs only if tests pass
  sonarqube-scan:
    name: SonarQube Quality Analysis
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download Coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/
      - name: SonarCloud Scan
        uses: sonarsource/sonarqube-scan-action@v3.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.organization=folajimiinfra
            -Dsonar.projectKey=folajimiinfra_test-snyk-project
            -Dsonar.sources=.
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
        continue-on-error: true
      - name: Check SonarQube Quality Gate
        id: sonarqube-quality-gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # 4. Veracode Scan Job: Runs only if tests pass (parallel with Snyk + SonarQube)
  veracode-scan:
    name: Veracode SAST Analysis
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci

      # Package the application for Veracode upload
      - name: Create Upload Artifact
        run: |
          echo "Packaging application for Veracode..."
          zip -r veracode-upload.zip . \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "coverage/*" \
            -x "*.zip" \
            -x ".github/*"
          echo "Upload artifact size: $(du -h veracode-upload.zip | cut -f1)"

      # Check if Veracode credentials are available
      - name: Check Veracode Credentials
        id: veracode-check
        run: |
          if [ -n "$VERACODE_VID" ] && [ -n "$VERACODE_VKEY" ]; then
            echo "has_creds=true" >> $GITHUB_OUTPUT
          else
            echo "has_creds=false" >> $GITHUB_OUTPUT
            echo "Veracode credentials not configured — skipping scan"
          fi
        env:
          VERACODE_VID: ${{ secrets.VERACODE_API_ID }}
          VERACODE_VKEY: ${{ secrets.VERACODE_API_KEY }}

      # Run Veracode Pipeline Scan (lightweight, fast, CI-friendly)
      - name: Veracode Pipeline Scan
        if: steps.veracode-check.outputs.has_creds == 'true'
        uses: veracode/Veracode-pipeline-scan-action@v1.0.18
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          file: veracode-upload.zip
          fail_build: false
        continue-on-error: true

      # Pipeline scan outputs results.json in the workspace root
      - name: Summarize Veracode Results
        if: always()
        run: |
          if [ -f results.json ]; then
            FLAW_COUNT=$(jq '.findings | length' results.json 2>/dev/null || echo "0")
            echo "Veracode Pipeline Scan found $FLAW_COUNT flaws"
          else
            echo "No results.json found"
            echo '{"findings":[]}' > results.json
          fi

      - name: Upload Veracode Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-results
          path: results.json
          if-no-files-found: ignore

  # 5. Semgrep Scan Job: FREE open-source SAST (runs parallel, no API key needed)
  semgrep-scan:
    name: Semgrep SAST Analysis
    needs: test
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4

      # Run Semgrep with auto config (uses community rules)
      - name: Run Semgrep Scan
        run: |
          echo "Running Semgrep SAST scan..."
          semgrep scan --config auto --json --output semgrep-results.json . || true
          echo "Semgrep scan complete"

      - name: Summarize Semgrep Results
        if: always()
        run: |
          if [ -f semgrep-results.json ]; then
            FINDING_COUNT=$(python3 -c "import json; d=json.load(open('semgrep-results.json')); print(len(d.get('results',[])))" 2>/dev/null || echo "0")
            echo "Semgrep found $FINDING_COUNT findings"
          else
            echo "No semgrep-results.json found"
            printf '{"results":[],"errors":[]}\n' > semgrep-results.json
          fi

      - name: Upload Semgrep Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep-results.json
          if-no-files-found: ignore

  # 6. Ingestion Job: Merges all results and pushes to CodeFabric
  ingest-to-codefabric:
    name: Ingest Results to CodeFabric
    needs: [snyk-scan, sonarqube-scan, veracode-scan, semgrep-scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download Snyk Results
        uses: actions/download-artifact@v4
        with:
          name: snyk-results
        continue-on-error: true
      - name: Download Veracode Results
        uses: actions/download-artifact@v4
        with:
          name: veracode-results
        continue-on-error: true
      - name: Download Semgrep Results
        uses: actions/download-artifact@v4
        with:
          name: semgrep-results
        continue-on-error: true
      - name: Fetch SonarQube Issues
        run: |
          echo "Waiting for SonarCloud to finish processing..."
          sleep 15
          curl -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=folajimiinfra_test-snyk-project&resolved=false" \
            > sonar-issues.json
      - name: Push to CodeFabric
        run: |
          CODEFABRIC_URL="${{ secrets.CODEFABRIC_URL }}"
          API_KEY="${{ secrets.CODEFABRIC_API_KEY }}"

          if [ -z "$API_KEY" ]; then
            echo "Error: CODEFABRIC_API_KEY secret is missing"
            exit 1
          fi

          echo "========================================"
          echo "  CodeFabric BYOS Ingestion Summary"
          echo "========================================"

          INGEST_FAILURES=0

          # Helper: push results to CodeFabric BYOS endpoint
          push_to_codefabric() {
            local tool_name="$1"
            local payload_file="$2"
            local http_code
            local body

            body=$(curl -s -w "\n%{http_code}" -X POST "$CODEFABRIC_URL/api/v1/byos/ingest" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: $API_KEY" \
              -d @"$payload_file")

            http_code=$(echo "$body" | tail -1)
            response=$(echo "$body" | sed '$d')

            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "$response" | jq -r '"  ✅ Ingested: tool=\(.tool), id=\(.ingest_id), findings=\(.total_findings)"' 2>/dev/null \
                || echo "  ✅ Ingested ($tool_name) — HTTP $http_code"
            else
              echo "  ❌ Failed to ingest $tool_name — HTTP $http_code"
              echo "  Response: $response" | head -5
              INGEST_FAILURES=$((INGEST_FAILURES + 1))
            fi
          }

          # ---- Push Snyk ----
          if [ -f snyk-results.json ] && [ -s snyk-results.json ] && jq -e '.' snyk-results.json > /dev/null 2>&1; then
            echo ""
            echo "--- Snyk SCA/Code ---"
            SNYK_VULNS=$(jq '.vulnerabilities | length' snyk-results.json 2>/dev/null || echo "0")
            echo "Snyk vulnerabilities: $SNYK_VULNS"

            jq -n --slurpfile snyk snyk-results.json \
            --arg sha "${{ github.sha }}" --arg branch "${{ github.ref_name }}" \
            '{tool: "snyk", scan_type: "SCA", format: "json", asset_id: "snyk-test-project", commit_sha: $sha, branch: $branch, scanner_output: $snyk[0]}' > payload.json

            push_to_codefabric "snyk" "payload.json"
          else
            echo "Snyk results file missing, empty or invalid JSON"
          fi

          # ---- Push SonarQube ----
          if [ -f sonar-issues.json ] && [ -s sonar-issues.json ] && jq -e '.' sonar-issues.json > /dev/null 2>&1; then
            echo ""
            echo "--- SonarQube SAST ---"
            SONAR_ISSUES=$(jq '.issues | length' sonar-issues.json 2>/dev/null || echo "0")
            echo "SonarQube issues: $SONAR_ISSUES"

            jq -n --slurpfile sonar sonar-issues.json \
            --arg sha "${{ github.sha }}" --arg branch "${{ github.ref_name }}" \
            '{tool: "sonarqube", scan_type: "SAST", format: "json", asset_id: "snyk-test-project", commit_sha: $sha, branch: $branch, scanner_output: $sonar[0]}' > payload.json

            push_to_codefabric "sonarqube" "payload.json"
          else
            echo "SonarQube issues file missing, empty or invalid JSON"
          fi

          # ---- Push Veracode ----
          if [ -f results.json ] && [ -s results.json ] && jq -e '.' results.json > /dev/null 2>&1; then
            echo ""
            echo "--- Veracode SAST ---"
            VERACODE_FLAWS=$(jq '.findings | length' results.json 2>/dev/null || echo "0")
            echo "Veracode flaws: $VERACODE_FLAWS"

            if [ "$VERACODE_FLAWS" != "0" ] && [ "$VERACODE_FLAWS" != "null" ]; then
              jq -n --slurpfile veracode results.json \
              --arg sha "${{ github.sha }}" --arg branch "${{ github.ref_name }}" \
              '{tool: "veracode", scan_type: "SAST", format: "json", asset_id: "snyk-test-project", commit_sha: $sha, branch: $branch, scanner_output: $veracode[0]}' > payload.json

              push_to_codefabric "veracode" "payload.json"
            else
              echo "  No Veracode flaws to ingest (0 findings)"
            fi
          else
            echo "Veracode results file missing, empty or invalid JSON"
          fi

          # ---- Push Semgrep ----
          if [ -f semgrep-results.json ] && [ -s semgrep-results.json ] && jq -e '.' semgrep-results.json > /dev/null 2>&1; then
            echo ""
            echo "--- Semgrep SAST ---"
            SEMGREP_FINDINGS=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "Semgrep findings: $SEMGREP_FINDINGS"

            if [ "$SEMGREP_FINDINGS" != "0" ] && [ "$SEMGREP_FINDINGS" != "null" ]; then
              jq -n --slurpfile semgrep semgrep-results.json \
              --arg sha "${{ github.sha }}" --arg branch "${{ github.ref_name }}" \
              '{tool: "semgrep", scan_type: "SAST", format: "json", asset_id: "snyk-test-project", commit_sha: $sha, branch: $branch, scanner_output: $semgrep[0]}' > payload.json

              push_to_codefabric "semgrep" "payload.json"
            else
              echo "  No Semgrep findings to ingest (0 findings)"
            fi
          else
            echo "Semgrep results file missing, empty or invalid JSON"
          fi

          if [ "$INGEST_FAILURES" -gt 0 ]; then
            echo ""
            echo "⚠️  $INGEST_FAILURES ingestion(s) failed — check logs above"
          fi

          echo ""
          echo "========================================"
          echo "  Ingestion Complete"
          echo "========================================"

  # 7. Finalize Job: Only runs if EVERYTHING passed
  pipeline-success:
    name: Finalize Pipeline
    needs: [test, sonarqube-scan, veracode-scan, semgrep-scan, ingest-to-codefabric]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Mark Pipeline as Fully Successful
        run: |
          echo "========================================"
          echo "  Pipeline completed successfully!"
          echo "========================================"
          echo "1. Tests Passed"
          echo "2. Coverage Threshold (80%) Met"
          echo "3. SonarQube Quality Gate Passed"
          echo "4. Veracode SAST Scan Complete"
          echo "5. Semgrep SAST Scan Complete"
          echo "6. Findings Ingested to CodeFabric"
          echo "========================================"
