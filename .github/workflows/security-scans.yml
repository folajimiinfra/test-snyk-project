name: Security CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1. Test Job: Runs tests and enforces coverage threshold
  test:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run Tests with 80% Coverage Threshold
        run: |
          # Enforce 80% coverage on branches, functions, lines, and statements
          npx jest --coverage --coverageThreshold='{"global":{"branches":80,"functions":80,"lines":80,"statements":80}}'
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # 2. Snyk Scan Job: Runs only if tests pass
  snyk-scan:
    name: Snyk Security Analysis
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Install Snyk CLI
        run: npm install -g snyk
      - name: Run Snyk SCA Scan
        run: |
          snyk test --json > snyk-sca.json || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Run Snyk Code Scan
        run: |
          snyk code test --json > snyk-code.json || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Merge Snyk Results
        run: |
          # Combine SCA and Code results into one JSON
          jq -s '.[0] * .[1]' snyk-sca.json snyk-code.json > snyk-results.json || cp snyk-sca.json snyk-results.json
      - name: Upload Snyk Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-results
          path: snyk-results.json

  # 3. SonarQube Scan Job: Runs only if tests pass
  sonarqube-scan:
    name: SonarQube Quality Analysis
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download Coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/
      - name: SonarCloud Scan
        uses: sonarsource/sonarqube-scan-action@v3.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.organization=folajimiinfra
            -Dsonar.projectKey=folajimiinfra_test-snyk-project
            -Dsonar.sources=.
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
        continue-on-error: true
      - name: Check SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  # 4. Ingestion Job: Merges all results and pushes to CodeFabric
  ingest-to-codefabric:
    name: Ingest Results to CodeFabric
    needs: [snyk-scan, sonarqube-scan]
    if: always() && needs.test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download Snyk Results
        uses: actions/download-artifact@v4
        with:
          name: snyk-results
          if-no-files-found: ignore
      - name: Fetch SonarQube Issues
        run: |
          # Fetch from SonarCloud API
          curl -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=folajimiinfra_test-snyk-project&resolved=false" \
            > sonar-issues.json
      - name: Push to CodeFabric
        run: |
          CODEFABRIC_URL="${{ secrets.CODEFABRIC_URL }}"
          
          # Push Snyk
          if [ -f snyk-results.json ] && [ -s snyk-results.json ]; then
            echo "Pushing Snyk findings..."
            jq -n --slurpfile snyk snyk-results.json \
            --arg sha "${{ github.sha }}" --arg branch "${{ github.ref_name }}" \
            '{tool: "snyk", scan_type: "SCA", format: "json", asset_id: "snyk-test-project", commit_sha: $sha, branch: $branch, scanner_output: $snyk[0]}' > payload.json
            curl -X POST "$CODEFABRIC_URL/api/v1/byos/ingest" -H "Content-Type: application/json" -d @payload.json
          fi
          
          # Push SonarQube
          if [ -f sonar-issues.json ] && [ -s sonar-issues.json ]; then
            echo "Pushing SonarQube findings..."
            jq -n --slurpfile sonar sonar-issues.json \
            --arg sha "${{ github.sha }}" --arg branch "${{ github.ref_name }}" \
            '{tool: "sonarqube", scan_type: "SAST", format: "json", asset_id: "snyk-test-project", commit_sha: $sha, branch: $branch, scanner_output: $sonar[0]}' > payload.json
            curl -X POST "$CODEFABRIC_URL/api/v1/byos/ingest" -H "Content-Type: application/json" -d @payload.json
          fi

  # 5. Finalize Job: Only runs if EVERYTHING passed (Tests, Coverage, Quality Gate)
  pipeline-success:
    name: Finalize Pipeline
    needs: [test, sonarqube-scan, ingest-to-codefabric]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Mark Pipeline as Fully Successful
        run: |
          echo "Pipeline completed successfully!"
          echo "1. Tests Passed"
          echo "2. Coverage Threshold (80%) Met"
          echo "3. Quality Gate Passed"
          echo "4. Findings Ingested to CodeFabric"
